---
title: 'r5r: rapid realistic routing on multimodal transport networks with R5 in R'
author: "Rafael H. M. Pereira, Marcus Saraiva, Daniel Herszenhut, Carlos Kaue Braga"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette: default
  github_document: default
abstract: "Routing is a key step in transport planning. Nonetheless, researchers and practitioners still face challenges regarding this task, such as the cost of licensed software and the long computation times to run complex scenarios. Conveyal's R<sup>5</sup> is a multimodal transport network router that offers meaningful planning features, such as accounting for service reliability issues and returning multiple travel time estimates and itineraries for a single origin/destination pair. This paper describes r5r, an open source R package built on top of R<sup>5</sup> that allow users to efficiently compute travel time matrices and generate detailed itineraries between a set of origins and destinations at no expense. The development of this package contributes to the transport field as it offers an easy-to-use powerful tool for robust planning and research."
urlcolor: blue
vignette: |
  %\VignetteIndexEntry{r5r-intro} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
bibliography: references.json
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

set.seed(0)
```

<!-- Examples of similar papers -->
<!--  - https://transportfindings.org/article/8416-accessibility-toolbox-for-r-and-arcgis -->

<!--  - https://transportfindings.org/article/6945-dodgr-an-r-package-for-network-flow-aggregation -->

<!--  - https://joss.theoj.org/papers/10.21105/joss.01926 -->

# RESEARCH QUESTIONS AND HYPOTHESES 

Transport routing is the process of finding the alternative routes and costs 
that connect places on a given transport network. Routing often involves complex
mathematical algorithms and it is a fundamental step required for transport
accessibility analysis, fleet allocation and transport simulation and planning
more broadly. Despite the long-standing importance of routing analysis to the 
field of transport and mobility studies, researchers and practitioners still 
frequently face practical challenges with this task. These challenges involve for
example the monetary costs of licensed software, data availability issues for data
hungry models, and the long computation times to run multiple routing scenarios, 
particularly in  large and complex multimodal transport networks. 

While there is a growing number of open source routing models [@opentripplanneropentripplanner; 
@lovelace2019stplanr; @padgham2019dodgr], most options available do not efficiently 
process large transport networks. More importantly, these softwares generate
deterministic estimates of travel times without accounting for issues of service
reliability (REF) and they only return the fastest route option between a set of
origins and destinations. This simple approach overlooks how often people's 
actual route choices deviate from shortest travel time paths, what
can occur due to multiple factors such as imperfect information, monetary costs 
and safety issues [@larsen2011travel; @zhu2015people; @conway2019getting].

This paper presents [r5r](https://ipeagit.github.io/r5r/), a new open source 
R package for rapid realistic routing on multimodal transport networks based on
the [Rapid Realistic Routing on Real-world and Reimagined networks (R<sup>5</sup>)](https://github.com/conveyal/r5). 
R<sup>5</sup> is a powerful next-generation routing engine written in Java and
developed at Conveyal [@conway2017evidencebased; @conway2018accounting] to
replace its predecessor OpenTripPlanner. The r5r package provides a simple and
friendly interface to run R<sup>5</sup> locally from within R, what allows users
to efficiently calculate travel time matrices or generate multiple route 
alternatives between origins and destinations using seamless parallel computing.

# METHODS AND DATA

r5r has low data requirements, enabling routing analysis on different contexts 
wherever data on street networks from OpenStreetMap (OSM) is available. The 
package is also easily scalable allowing for fast computations at either the 
city or country level analysis. For multimodal transport routing, r5r will 
automatically combine OSM data with one or multiple public transport data sets 
provided by the user in  the standard GTFS format to create a routable transport
network.

The r5r package has 3 fundamental functions:

- `setup_r5()`: builds a multimodal transport network used for routing in 
R<sup>5</sup>. This function (1) downloads/updates a compiled R<sup>5</sup> JAR 
file, tailored for the purposes of the package, and stores it locally in the r5r 
package directory for future use; and (2) combines the OSM and GTFS data sets to 
build a routable network object.

- `travel_time_matrix()`: computes travel time estimates between one or 
multiple origin/destination pairs for a single departure time or for multiple
departure times over a time window. This function uses an R5-specific extension 
to the RAPTOR routing algorithm which provides an efficient and systematic 
sample of multiple departures per minute over a `time_window` set by the user 
[@conway2017evidencebased]. If the user passes a `time_window` parameter to the 
function, r5r calculates multiple travel time matrices departing each minute and 
return additional information on the percentile distribution of travel times 
that allows one to grasp service reliability issues.

- `detailed_itineraries()`: computes detailed information on either the
shortest or multiple alternative routes between one or multiple origin/destination
pairs for a single departure time. The output includes detailed information on
route alternatives such as the transport mode, waiting time, travel time and 
distance of each segment of the trip. This function uses an R5-specific 
extension to the McRAPTOR routing algorithm to find optimal or less than optimal 
paths. The specific extension to McRAPTOR to do suboptimal path routing are not 
documented yet, but a detailed description of base McRAPTOR can be found in 
@delling2015roundbased.

Both routing functions are versatile so users can easily set customized inputs
such as transport modes, departure date and times, walking and cycling speeds, 
maximum trip duration, walking distances and number of public transport 
transfers, etc.

# FINDINGS

The package can be installed with the following command:

```{r, message = FALSE, eval = FALSE}
# stable version
install.packages("r5r")
```

The first step when using r5r is to set the amount of memory available to Java. 
By default `R` allocates only 512 MB of memory for Java processes~~, which is not 
enough for large queries using r5r~~. To increase available memory to 2GB, for 
example, we need to set the `java.parameters` option at the beginning of the 
script as follows:

```{r, message = FALSE}
options(java.parameters = "-Xmx2G")
```

The package can be attached (with some other packages used in this article) with 
the following command:

```{r, message = FALSE}
library(r5r)
library(sf)
library(data.table)
library(ggplot2)
```

To illustrate functionality, the package includes a small sample data set for 
the city of São Paulo (Brazil). It includes three files:

- An OSM network in `.pbf` format.
- A public transport network in `GTFS.zip` format.
- The spatial coordinates of points covering the area in `.csv` format.

```{r}
# points to directory with data
data_path <- system.file("extdata/spo", package = "r5r")

list.files(data_path)

# read points of origin and destination
points <- fread(file.path(data_path, "spo_hexgrid.csv"))
points <- points[c(sample(1:nrow(points), 100))]
head(points)
```

### Build a routable transport network

To build a routable transport network with r5r, the user only needs one command
line pointing to where the input data is stored:

```{r, message = FALSE}
r5r_core <- setup_r5(data_path)
```

The function uses the `.pbf` and the `GTFS.zip` files in the directory pointed 
by `data_path` to create a multimodal transport network used for routing by 
R<sup>5</sup>. The resulting `network.dat` as well as some other files used by 
R<sup>5</sup> are saved inside the supplied directory.

The presence of a `.pbf` file with OpenStreetMap data is mandatory because it is
required to create a street network. Meanwhile, a `GTFS.zip` file is only used to
calculate public transport trips, thus may not be necessary if that's not intended.
Multiple GTFS feeds can be used simultaneously, in which case R<sup>5</sup> will
merge all files into a single network automatically.
   
### Calculate a travel time matrix

Calculating a travel time matrix with r5r can be done very efficiently with the
`travel_time_matrix()` function. The function takes origins/destinations spatial
location (either as a spatial `sf POINT` object, or as a `data.frame` containing
the columns `id`, `lon` and `lat`) and travel parameters as inputs and outputs a
`data.table` with the travel time estimates between all combinations of origins 
and destinations that can be reached with the given parameters.

The `time_window` parameter is set to 1 by default, which means that travel time 
estimates will be calculated using a single departure time (specified by 
`departure_datetime`):

```{r, message = FALSE}
mode <- c("WALK", "TRANSIT")
max_walk_dist <- 1000
max_trip_duration <- 120
departure_datetime <- as.POSIXct("13-03-2019 14:00:00",
                                 format = "%d-%m-%Y %H:%M:%S")

# calculate travel time matrix
ttm <- travel_time_matrix(r5r_core,
                          origins = points,
                          destinations = points,
                          mode = mode,
                          departure_datetime = departure_datetime,
                          max_walk_dist = max_walk_dist,
                          max_trip_duration = max_trip_duration)

head(ttm)
```

Alternatively, a bigger time window can be specified. In such cases several 
travel time matrices are calculated using every minute from `departure_datetime` 
to the end of the given window as a distinct departure time. By default the 
function outputs the 50th percentile (i.e. the median) travel time between each 
origin and destination pair, which can be overruled by the `percentiles` 
parameter:

```{r, message = FALSE}
time_window <- 60
percentiles <- c(25, 50, 75)

# calculate travel time matrix
ttm <- travel_time_matrix(r5r_core,
                          origins = points,
                          destinations = points,
                          mode = mode,
                          departure_datetime = departure_datetime,
                          max_walk_dist = max_walk_dist,
                          max_trip_duration = max_trip_duration,
                          time_window = time_window,
                          percentiles = percentiles)

ttm
```

Since the sample data holds information for few transit routes, many trips rely 
only on walking to be completed. Consequently, the travel time estimates of such 
trips are not affected by transit reliability issues. This is the case of the 
first five rows of `ttm`, which present the same estimate regardless of the 
percentile they represent. The effect of the `time_window` and `percentiles` 
parameters can be observed above in the last rows of `ttm`, in which the 
estimates grow along the increase of the percentile they depict.

### Calculate detailed itineraries

Often enough one wants more information on the itineraries between 
origin/destination pairs than simply the travel time. For such cases, the 
package includes the `detailed_itineraries()` function, which also takes travel 
restrictions as inputs, but outputs a much more detailed data table at the trip 
segment level. Another key feature of this function is that it (optionally) 
provides multiple alternative routes between origin/destination pairs. The 
algorithm doesn't yet support frequency-based trips (such as São Paulo's), 
however, so we use another data sample included in the package that covers the 
city of Porto Alegre (Brazil):

```{r, message = FALSE}
data_path <- system.file("extdata/poa", package = "r5r")

r5r_core <- setup_r5(data_path)

# load points of interests and set origin and destination
points <- fread(file.path(data_path, "poa_points_of_interest.csv"))
origins <- points[c(10, 14),]
destinations <- points[c(12, 15),]

# set restrictions
mode <- c("WALK", "TRANSIT")
max_walk_dist <- Inf
max_trip_duration <- 120
departure_datetime <- as.POSIXct("13-03-2019 14:00:00",
                                 format = "%d-%m-%Y %H:%M:%S")

dit <- detailed_itineraries(r5r_core,
                            origins = origins,
                            destinations = destinations,
                            mode = mode,
                            departure_datetime = departure_datetime,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            shortest_path = FALSE)

dit
```

Since the `shortest_path` argument has been set to `FALSE`, `dit` holds 
information for multiple itineraries between the same origin/destination pairs:

```{r, message = FALSE}
setDT(copy(dit))[, .(n_itineraries = uniqueN(option)), by = .(fromId, toId)]
```

### Visualize results

`detailed_itineraries()` output is a `sf` object, which means that each trip 
segment is associated to a spatial geometry that can be plotted with common `R` 
packages, such as `ggplot2`. The package also offers a handy 
`street_network_to_sf()` function which extracts the OSM street network used by 
R<sup>5</sup> as a `sf` object and that can be used to provide geographic 
context for the visualization.

```{r, message = FALSE, fig.width = 7, fig.height = 5}
# extract OSM network
street_net <- street_network_to_sf(r5r_core)

dit$facet_labels <- paste0(dit$fromId, " to\n", dit$toId)

ggplot() +
   geom_sf(data = street_net$edges, color = "gray85") +
   geom_sf(data = dit, aes(color = mode), size = 1) +
   facet_wrap(~ facet_labels, nrow = 1) +
   theme_minimal() + 
   theme(legend.position = "bottom", axis.text.x = element_text(angle = 30, hjust = 1))
```

The picture above can be used to compare the walking-only to the walking and 
transit itineraries between each origin/destination pair. Given that Porto 
Alegre's sample `GTFS.zip` file includes only very few public transport routes, 
the resulting plot picture some odd scenarios, such as a fairly lengthy 
circular-like bus route, in the leftmost facet, and a very long walking access 
trip to the bus, in the rightmost facet.  

# Acknowledgments

The [R<sup>5</sup> routing engine](https://github.com/conveyal/r5) is developed 
at [Conveyal](https://www.conveyal.com/) with contributions from several developers. 
This work was supported by the Brazilian Institute for Applied Economic Research 
(Ipea).

# References




<!-- Rafa's notes -->
<!-- jean: #>-  mass of assumptions regarding decision-making and routing (Miller, 2018).  -->
<!-- Haugen, 2011; Schwanen, 2008 -->

<!-- Miller, E.J., 2018. Accessibility: measurement and application in transportation planning. Transp. Rev. 38, #>551–555. https://doi.org/10.1080/01441647.2018.1492778 -->

<!-- This article presents **r5r**, a new open-source `R` package for rapid  -->
<!-- realistic routing on multimodal transport networks. -->
