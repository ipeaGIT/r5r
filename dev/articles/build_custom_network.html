<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building a custom network with modified OSM car speeds • r5r</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building a custom network with modified OSM car speeds">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">r5r</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.2.0999999</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/r5r.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/accessibility.html">Accessibility</a></li>
    <li><a class="dropdown-item" href="../articles/build_custom_network.html">Building a custom network with modified OSM car speeds</a></li>
    <li><a class="dropdown-item" href="../articles/detailed_itineraries.html">Trip planning with detailed_itineraries()</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ - Frequently Asked Questions</a></li>
    <li><a class="dropdown-item" href="../articles/fare_structure.html">Accounting for monetary costs</a></li>
    <li><a class="dropdown-item" href="../articles/isochrones.html">Isochrones</a></li>
    <li><a class="dropdown-item" href="../articles/pareto_frontier.html">Trade-offs between travel time and monetary cost</a></li>
    <li><a class="dropdown-item" href="../articles/time_window.html">Using the time_window parameter</a></li>
    <li><a class="dropdown-item" href="../articles/travel_time_matrix.html">Travel time matrices</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ipeaGIT/r5r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="build_custom_network_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="build_custom_network_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="build_custom_network_files/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="build_custom_network_files/leaflet-1.3.1/leaflet.js"></script><link href="build_custom_network_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="build_custom_network_files/proj4-2.6.2/proj4.min.js"></script><script src="build_custom_network_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="build_custom_network_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="build_custom_network_files/leaflet-binding-2.2.2/leaflet.js"></script><script src="build_custom_network_files/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script><script src="build_custom_network_files/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script><script src="build_custom_network_files/HomeButton-0.0.1/home-button.js"></script><script src="build_custom_network_files/HomeButton-0.0.1/easy-button-src.min.js"></script><link href="build_custom_network_files/congestion_poly%20-%20scale-CSS-0.0.1/congestion_poly%20-%20scale_home-button.css" rel="stylesheet">
<script src="build_custom_network_files/clipboard-0.0.1/setClipboardText.js"></script><link href="build_custom_network_files/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet">
<link href="build_custom_network_files/mapviewCSS-0.0.1/mapview.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Building a custom network with modified OSM car speeds</h1>
            
            <h4 data-toc-skip class="date">2025-07-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ipeaGIT/r5r/blob/master/vignettes/build_custom_network.Rmd" class="external-link"><code>vignettes/build_custom_network.Rmd</code></a></small>
      <div class="d-none name"><code>build_custom_network.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette shows how to build a custom transport network with
      modified OSM car speeds, which can be used to simulate different
      scenarios of traffic congestion and road closures.
    </div>
    
<div class="section level2">
<h2 id="introduction">1. Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>By default, routing by car in <code>R5</code> considers that vehicles
travel at the legal speed limit in each OSM road edge. This is commonly
referred to as a “free flow scenario”, without congestion. However, the
average speed of car trips is different (usually slower) than the legal
speed limit in most real case scenarios due to traffic conditions and
driving behavior.</p>
<p>This vignette shows how you can set custom speeds for cars by making
simple changes to OSM data with the convenient
<code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> function. OSM speeds can be changed
using two different strategies: (1) by applying different speed factors
to each road, or (2) by applying speed factors only to the roads within
determined polygons.</p>
<p>The <code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> has a relatively similar
behavior to the <code><a href="../reference/build_network.html">r5r::build_network()</a></code> function. It builds a
transport network that can be used in the routing and accessibility
function in <code>r5r</code>. The two key differences here are:</p>
<ol style="list-style-type: decimal">
<li>The user needs to pass a directory path where the new transport
network is going to be saved. This is done with the
<code>output_path</code> parameter. In this vignnete, we will simply use
the default behavior of the <code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> function
that builds the new network in a temporary directory.</li>
<li>The user needs to pass some info to the <code>new_carspeeds</code>,
which can be either a <code>data.frame</code> that indicates the speed
factor for each OSM edge id, OR an <code>sf data.frame</code> polygon
that indicates the speed factor for all the roads that fall within that
polygon.</li>
</ol>
<p>Let’s see how this works with a few examples using the a sample data
set for the city of Porto Alegre (Brazil) included in
<code>r5r</code>.</p>
</div>
<div class="section level2">
<h2 id="changing-car-speeds-by-osm-edge">2. Changing car speeds by OSM edge<a class="anchor" aria-label="anchor" href="#changing-car-speeds-by-osm-edge"></a>
</h2>
<div class="section level3">
<h3 id="basic-usage">2.1 Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h3>
<p>In this first example, we will pass the new car speeds using a sample
<code>data.frame</code> that comes with the package. Mind you that this
data frame must have the two columns: <code>"osm_id"</code> and
<code>"max_speed"</code>. Like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># increase Java memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>java.parameters <span class="op">=</span> <span class="st">"-Xmx2G"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ipeaGIT/r5r" class="external-link">r5r</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># data path where the .pbf file is located</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read data.frame with speed factors</span></span>
<span><span class="va">speed_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa/poa_osm_congestion.csv"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">speed_factors</span><span class="op">)</span></span>
<span><span class="co">#&gt;      osm_id max_speed</span></span>
<span><span class="co">#&gt; 1  27184648       0.5</span></span>
<span><span class="co">#&gt; 2 762361901       0.5</span></span>
<span><span class="co">#&gt; 3 568609955       0.5</span></span>
<span><span class="co">#&gt; 4 709834913       0.5</span></span>
<span><span class="co">#&gt; 5 709834914       0.5</span></span>
<span><span class="co">#&gt; 6  77705540       0.5</span></span></code></pre></div>
<p>In this example, the values of the <code>"max_speed"</code> column
are all set to <code>0.5</code>. Since we also set the parameter
<code>percentage_mode = TRUE</code>, this means that the driving speed
of those OSM edges listed in the <code>data.frame</code> will be at 50%
of the original speed in the OSM data. Mind you that the values in the
<code>"max_speed"</code> column also accept absolute values in Km/h, in
which case you must use <code>percentage_mode = FALSE</code>.</p>
<p>Now to build a new routeable transport network consideering these new
driving speeds, you simply need to call the
<code><a href="../reference/build_custom_network.html">r5r::build_custom_network()</a></code> function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r5r_network_congestion1</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">speed_factors</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And that’s it ! You can now use the new network
<code>r5r_network_congestion1</code> in any of <code>r5r</code>’s
routing and accessibility functions, like this.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load origin/destination points</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"poa_points_of_interest.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ttm_congestion</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/travel_time_matrix.html">travel_time_matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">r5r_network_congestion1</span>,</span>
<span>  origins <span class="op">=</span> <span class="va">points</span>,</span>
<span>  destinations <span class="op">=</span> <span class="va">points</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">'car'</span>,</span>
<span>  departure_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_trip_duration <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Obs. Mind you however that, even though we have set the speed factors
to <code>0.5</code>, travel times might not become twice as long. This
is because of how travel times by car are also affected by
intersections, and how changes in the road speeds might also affect the
route and hence the trip distance itself.</p>
<p>Now let’s dive into more realistic examples.</p>
</div>
<div class="section level3">
<h3 id="setting-different-congestion-levels-by-road-hierarchy">2.2 Setting different congestion levels by road hierarchy<a class="anchor" aria-label="anchor" href="#setting-different-congestion-levels-by-road-hierarchy"></a>
</h3>
<p>In this example, we’ll set different speed factor for roads of
different hierarchy levels. We can assume for example that congestion
levels tend to be more intense in roads of higher hierarchy. We can do
this in two simple steps.</p>
<p>First we need to do read the OSM data from our <code>.pbf</code>
file, and to filter the OSM edges with the road types we want.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># path to OSM pbf</span></span>
<span><span class="va">pbf_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"/poa_osm.pbf"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># read layer of lines from pbf</span></span>
<span><span class="va">roads</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="va">pbf_path</span>, </span>
<span>  layer <span class="op">=</span> <span class="st">'lines'</span>, </span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter only road types of interest</span></span>
<span><span class="va">rt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"motorway"</span>, <span class="st">"primary"</span>, <span class="st">"secondary"</span>, <span class="st">"tertiary"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">roads</span> <span class="op">&lt;-</span> <span class="va">roads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">osm_id</span>, <span class="va">highway</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">highway</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">rt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">roads</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -51.21315 ymin: -30.06624 xmax: -51.15025 ymax: -30.04939</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;     osm_id highway                       geometry</span></span>
<span><span class="co">#&gt; 1 26786712 primary LINESTRING (-51.15164 -30.0...</span></span>
<span><span class="co">#&gt; 2 26786730 primary LINESTRING (-51.17265 -30.0...</span></span>
<span><span class="co">#&gt; 3 26786732 primary LINESTRING (-51.15025 -30.0...</span></span>
<span><span class="co">#&gt; 4 26847798 primary LINESTRING (-51.21315 -30.0...</span></span>
<span><span class="co">#&gt; 5 26936215 primary LINESTRING (-51.20818 -30.0...</span></span>
<span><span class="co">#&gt; 6 26936224 primary LINESTRING (-51.20818 -30.0...</span></span></code></pre></div>
<p>Here’s how the road network looks like.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># map</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">roads</span><span class="op">[</span><span class="st">"highway"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="build_custom_network_files/figure-html/unnamed-chunk-6-1.png" width="100%"></p>
<p>Now we only need to add a new column <code>"max_speed"</code> with
values conditioned on the road type, and make sure the
<code>osm_id</code> is of class <code>numeric</code>. The
<code>data.frame</code> looks like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_edge_speeds</span> <span class="op">&lt;-</span> <span class="va">roads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    osm_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">osm_id</span><span class="op">)</span>,</span>
<span>    max_speed <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"motorway"</span>  <span class="op">~</span> <span class="fl">0.75</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"primary"</span>   <span class="op">~</span> <span class="fl">0.8</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"secondary"</span> <span class="op">~</span> <span class="fl">0.85</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"tertiary"</span>  <span class="op">~</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">new_edge_speeds</span><span class="op">)</span></span>
<span><span class="co">#&gt;     osm_id highway max_speed</span></span>
<span><span class="co">#&gt; 1 26786712 primary       0.8</span></span>
<span><span class="co">#&gt; 2 26786730 primary       0.8</span></span>
<span><span class="co">#&gt; 3 26786732 primary       0.8</span></span>
<span><span class="co">#&gt; 4 26847798 primary       0.8</span></span>
<span><span class="co">#&gt; 5 26936215 primary       0.8</span></span>
<span><span class="co">#&gt; 6 26936224 primary       0.8</span></span></code></pre></div>
<p>That’s it. Now we can pass the <code>new_speeds</code> data frame to
<code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> along with the path to the directory
where the original OSM <code>.pbf</code> file is stored and the function
will build a new routable transport network with modified OSM car
speeds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">r5r_network_congestion2</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">new_edge_speeds</span>,</span>
<span>  output_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="applying-the-same-speed-factor-to-all-roads">2.3. Applying the same speed factor to all roads<a class="anchor" aria-label="anchor" href="#applying-the-same-speed-factor-to-all-roads"></a>
</h3>
<p>The <code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> function has a parameter
<code>default_speed</code>, which can be used to set the speed of all
the roads not listed in the <code>new_carspeeds</code> input. By
default, <code>default_speed = NULL</code> and the speeds of the
unlisted roads are kept unchanged.</p>
<p>In this example, we’ll use this parameter to apply the same speed
factor to all roads to simulate as if the speed limits of all roads were
changed to 40 Km/h. To do this, we only need to create a
<code>data.frame</code> with a mock OSM id that that does not exist in
our OSM data and to pass <code>default_speed = 40</code> with
<code>percentage_mode = FALSE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create df with a road that does not exist.</span></span>
<span><span class="va">mock_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>osm_id <span class="op">=</span> <span class="fl">9999</span>, max_speed <span class="op">=</span> <span class="fl">9999</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a temp dir where the custom network will be saved</span></span>
<span><span class="va">new_temp_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span>tmpdir<span class="op">=</span><span class="st">'./40kmph'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">new_temp_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build network with all roads at at 40 Km/h </span></span>
<span><span class="va">r5r_network_20kmph</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">mock_data</span>,</span>
<span>  output_path <span class="op">=</span> <span class="va">new_temp_dir</span>,</span>
<span>  default_speed <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="extra-tip">Extra tip:<a class="anchor" aria-label="anchor" href="#extra-tip"></a>
</h4>
<ul>
<li>
<strong>Road closure</strong>: one can simulate a road closure by
setting the <code>"max_speed"</code> value to <code>0</code>. This can
be quite handy for studies that try to measure the resilience of
transport systems to network disruptions.</li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="changing-car-speeds-with-a-spatial-polygon">3. Changing car speeds with a spatial polygon<a class="anchor" aria-label="anchor" href="#changing-car-speeds-with-a-spatial-polygon"></a>
</h2>
<p>If you do not want to set the speed factor for each individual OSM
road edge, is to use one or more spatial polygons to set speed the speed
factors of all the roads within those polygons. In this example with the
sample data from {r5r}, we have two polygons in the city of Porto
Alegre. The first one is covers the extended city center, and the second
polygon covers a few important roads that connect two major avenues in
the city.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read sf with congestion polygons</span></span>
<span><span class="va">congestion_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"poa_poly_congestion.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># preview</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html" class="external-link">mapview</a></span><span class="op">(</span><span class="va">congestion_poly</span>, zcol<span class="op">=</span><span class="st">"scale"</span><span class="op">)</span></span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addPolygons","args":[[[[{"lng":[-51.22462817818951,-51.22464345767516,-51.22468712416484,-51.22475905837024,-51.224859063514,-51.22498686586479,-51.22514211548354,-51.22532438717864,-51.22553318166761,-51.22576792694227,-51.22602797983341,-51.22631262777096,-51.22662109073468,-51.22695252339018,-51.22730601740437,-51.22768060393405,-51.22807525628075,-51.2284888927047,-51.22892037939001,-51.2293685335532,-51.22983212668622,-51.23030988792542,-51.23080050753686,-51.23130264050877,-51.23181491024082,-51.23233591232056,-51.2328642183762,-51.23339837999551,-51.2339369326997,-51.23447839996169,-51.23502129725738,-51.23556413613908,-51.23610542831964,-51.23664368975615,-51.23717744472201,-51.23770522985604,-51.23822559817758,-51.23873712305645,-51.23923840212704,-51.23972806113538,-51.24020475770907,-51.24066718503936,-51.24111407546535,-51.2415442039506,-51.24195639144237,-51.2423495081044,-51.24272247641443,-51.2430742741177,-51.2434039370287,-51.2437105616731,-51.24399330776299,-51.24425140049835,-51.24448413268872,-51.24469086668908,-51.24487103614477,-51.24502414754063,-51.2451497815503,-51.24524759418173,-51.24531731771609,-51.24535876143749,-51.24537181215134,-51.24535643449024,-51.24531267100654,-51.24524064205129,-51.24514054543992,-51.24501265590589,-51.24485732434348,-51.24467497684211,-51.24446611351478,-51.24423130712389,-51.24397120150824,-51.24368650981558,-51.24337801254553,-51.24304655540836,-51.24269304700537,-51.24231845633741,-51.24192381014829,-51.24151019011033,-51.24107872985986,-51.24063061189078,-51.24016706431456,-51.23968935749573,-51.23919880057196,-51.23869673786824,-51.23818454521501,-51.23766362618024,-51.23713540822583,-51.23660133879879,-51.23606288136781,-51.23552151141617,-51.23497871240176,-51.23443597169553,-51.23389477650899,-51.23335660982234,-51.2328229463241,-51.2322952483733,-51.23177496199543,-51.23126351292282,-51.2307623026906,-51.23027270479849,-51.2297960609493,-51.22933367737411,-51.22888682125444,-51.22845671725086,-51.2280445441479,-51.22765143162413,-51.22727845715652,-51.22692664306726,-51.2265969537214,-51.22629029288289,-51.22600750123621,-51.22574935408049,-51.22551655920243,-51.22530975493389,-51.22512950839938,-51.22497631395856,-51.22485059184766,-51.22475268702396,-51.22468286821638,-51.22464132718465,-51.22462817818951],"lat":[-30.03451811764823,-30.0349903988785,-30.0354613370328,-30.03592964127256,-30.03639402796095,-30.0368532241817,-30.03730597122886,-30.03775102805761,-30.03818717468699,-30.03861321554502,-30.03902798274697,-30.03943033929809,-30.03981918221144,-30.04019344553294,-30.04055210326485,-30.04089417217975,-30.04121871451742,-30.04152484055705,-30.04181171105779,-30.04207853956099,-30.04232459454752,-30.04254920144474,-30.042751744477,-30.04293166835508,-30.04308847979965,-30.04322174889464,-30.04333111026676,-30.04341626408798,-30.04347697689818,-30.0435130822457,-30.04352448114403,-30.04351114234338,-30.04347310241644,-30.04341046565794,-30.04332340379854,-30.04321215553354,-30.04307702586792,-30.04291838527951,-30.04273666870242,-30.04253237433374,-30.04230606226656,-30.04205835295345,-30.04178992550408,-30.04150151582221,-30.04119391458676,-30.04086796508292,-30.04052456088874,-30.04016464342404,-30.03978919936817,-30.0393992579537,-30.03899588814356,-30.0385801956993,-30.03815332014863,-30.03771643166042,-30.03727072783603,-30.03681743042524,-30.03635778197657,-30.03589304243036,-30.03542448566468,-30.03495339600293,-30.03448106469325,-30.03400878636899,-30.03353785550013,-30.03306956284542,-30.03260519191475,-30.03214601545175,-30.03169329194592,-30.03124826218416,-30.03081214585084,-30.03038613818602,-30.02997140671077,-30.02956908802841,-30.02918028471101,-30.02880606227877,-30.02844744628147,-30.02810541948927,-30.0277809192009,-30.02747483467647,-30.02718800470194,-30.026921215292,-30.02667519753744,-30.02645062560297,-30.0262481148812,-30.02606822030734,-30.02591143483964,-30.02577818810961,-30.02566884524545,-30.02558370587245,-30.02552300329242,-30.02548690384493,-30.02547550645186,-30.02548884234648,-30.02552687498799,-30.02558950016144,-30.02567654626311,-30.02578777477035,-30.02592288089463,-30.02608149441607,-30.02626318069709,-30.02646744187257,-30.02669371821303,-30.02694138965737,-30.02720977751082,-30.02749814630344,-30.02780570580426,-30.02813161318538,-30.02847497533027,-30.02883485127979,-30.02921025480944,-30.02960015713066,-30.03000348970884,-30.03041914719034,-30.03084599043053,-30.0312828496145,-30.03172852746202,-30.03218180250786,-30.03264143244857,-30.03310615754656,-30.03357470408207,-30.0340457878438,-30.03451811764823]}]],[[{"lng":[-51.21425634714618,-51.21426396228409,-51.2142857708964,-51.21432171330683,-51.21437169109706,-51.21443556737543,-51.21451316715108,-51.21460427781262,-51.21470864970996,-51.21482599683778,-51.21495599761859,-51.21509829578352,-51.21525250134822,-51.21541819168127,-51.21559491266223,-51.21578217992603,-51.21597948019047,-51.216186272663,-51.21640199052308,-51.21662604247599,-51.21685781437381,-51.21709667089914,-51.21734195730702,-51.21759300122014,-51.21784911447244,-51.2181095949962,-51.21837372874712,-51.2186407916625,-51.21891005164677,-51.21918077057919,-51.21945220633803,-51.21972361483578,-51.21999425205977,-51.22026337611253,-51.2205302492464,-51.22079413988669,-51.2210543246379,-51.22131009026753,-51.22156073566185,-51.22180557374849,-51.22204393338047,-51.22227516117639,-51.22249862331196,-51.2227137072577,-51.22291982345828,-51.22311640694867,-51.22330291890292,-51.22347884811098,-51.22364371237992,-51.22379705985534,-51.22393847025961,-51.22406755604338,-51.22418396344736,-51.2242873734713,-51.22437750274763,-51.22445410431742,-51.22451696830637,-51.2245659224991,-51.22460083281024,-51.22462160365088,-51.22462817818951,-51.22462053850672,-51.22459870564316,-51.2245627395408,-51.22451273887753,-51.22444884079563,-51.22437122052484,-51.2242800909011,-51.22417570178224,-51.22405833936227,-51.22392832538623,-51.22378601626754,-51.2236318021106,-51.22346610564092,-51.22328938104622,-51.22310211273113,-51.22290481398939,-51.22269802559684,-51.22248231432935,-51.22225827140939,-51.22202651088593,-51.22178766795173,-51.22154239720285,-51.22129137084504,-51.22103527685202,-51.22077481708051,-51.22051070534743,-51.22024366547424,-51.21997442930408,-51.21970373469677,-51.21943232350753,-51.21916093955465,-51.21889032658192,-51.21862122622109,-51.21835437596025,-51.21809050712349,-51.21783034286742,-51.2175745962,-51.21732396802721,-51.21707914523271,-51.21684079879596,-51.21660958195379,-51.21638612841047,-51.21617105060135,-51.21596493801453,-51.21576835557541,-51.21558184209847,-51.21540590881042,-51.2152410379489,-51.21508768144052,-51.2149462596619,-51.214817160287,-51.21470073722401,-51.21459730964477,-51.21450716110915,-51.2144305387871,-51.21436765278033,-51.21431867554539,-51.21428374142015,-51.21426294625441,-51.21425634714618],"lat":[-30.03453541763529,-30.03477155897901,-30.03500702991516,-30.03524118502689,-30.03547338249947,-30.03570298587963,-30.03592936582022,-30.03615190180546,-30.03636998385194,-30.03658301418082,-30.03679040885675,-30.03699159938866,-30.03718603428844,-30.03737318058289,-30.03755252527503,-30.03772357675066,-30.03788586612633,-30.03803894853496,-30.0381824043456,-30.03831584031426,-30.03843889066201,-30.03855121807815,-30.03865251464508,-30.03874250268271,-30.03882093551,-30.03888759812123,-30.03894230777584,-30.03898491449939,-30.03901530149492,-30.03903338546326,-30.03903911683137,-30.03903247988838,-30.03901349282863,-30.03898220770177,-30.03893871027002,-30.03888311977295,-30.03881558860051,-30.03873630187511,-30.03864547694391,-30.03854336278283,-30.03843023931376,-30.03830641663695,-30.03817223418062,-30.03802805977023,-30.03787428861979,-30.03771134224822,-30.03753966732345,-30.03735973443773,-30.03717203681721,-30.03697708896967,-30.0367754252738,-30.036567598514,-30.03635417836488,-30.03613574982949,-30.03591291163537,-30.03568627459322,-30.03545645992241,-30.03522409754801,-30.03498982437402,-30.03475428253747,-30.03451811764823,-30.03428197701941,-30.03404650789317,-30.03381235566651,-30.03358016212254,-30.03335056367152,-30.03312418960656,-30.03290166037908,-30.03268358589848,-30.03247056386065,-30.03226317811014,-30.03206199704021,-30.03186757203533,-30.03168043596028,-30.03150110170004,-30.03133006075454,-30.03116778189187,-30.03101470986395,-30.03087126418792,-30.03073783799681,-30.03061479696239,-30.03050247829333,-30.03040118981137,-30.03031120910805,-30.03023278278406,-30.03016612577384,-30.0301114207566,-30.03006881765597,-30.0300384332292,-30.03002035074735,-30.03001461976715,-30.03002125599522,-30.03004024124508,-30.03007152348686,-30.03011501699,-30.03017060255793,-30.03023812785472,-30.03031740782237,-30.03040822518771,-30.03051033105772,-30.03062344560137,-30.03074725881621,-30.03088143137763,-30.03102559556864,-30.03117935628717,-30.0313422921286,-30.03151395654035,-30.03169387904541,-30.03188156653129,-30.03207650460129,-30.03227815898384,-30.03248597699656,-30.03269938906069,-30.03291781026176,-30.03314064195259,-30.03336727339373,-30.03359708342719,-30.03382944217866,-30.03406371278387,-30.03429925313394,-30.03453541763529]}]]],null,"congestion_poly - scale",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"polygon","stroke":true,"color":"#333333","weight":0.5,"opacity":[0.9,0.9],"fill":true,"fillColor":["#4B0055","#FDE333"],"fillOpacity":[0.6,0.6],"smoothFactor":1,"noClip":false},["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>poly_id&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>2<\/td><th>scale&emsp;<\/th><td>0.7&emsp;<\/td><\/tr><tr><td>3<\/td><th>priority&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POLYGON&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>poly_id&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>2<\/td><th>scale&emsp;<\/th><td>0.8&emsp;<\/td><\/tr><tr><td>3<\/td><th>priority&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POLYGON&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["0.7","0.8"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},{"stroke":true,"weight":1,"opacity":0.9,"fillOpacity":0.84,"bringToFront":false,"sendToBack":false}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-51.24537181215134,-30.04352448114403,-51.21425634714618,-30.02547550645186,true,"congestion_poly - scale","Zoom to congestion_poly - scale","<strong> congestion_poly - scale <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"congestion_poly - scale",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#4B0055 , #4B0055 0%, #723357 20%, #965D56 40%, #B98852 60%, #DBB548 80%, #FDE333 100%, #FDE333 "],"labels":["0.70","0.72","0.74","0.76","0.78","0.80"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"numeric","title":"congestion_poly - scale","extra":{"p_1":0,"p_n":1},"layerId":null,"className":"info legend","group":"congestion_poly - scale"}]}],"limits":{"lat":[-30.04352448114403,-30.02547550645186],"lng":[-51.24537181215134,-51.21425634714618]},"fitBounds":[-30.04352448114403,-51.24537181215134,-30.02547550645186,-51.21425634714618,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\"position\":\"relative\",\"bottomleft\":\"0px\",\"background-color\":\"rgba(255, 255, 255, 0.7)\",\"box-shadow\":\"0 0 2px #bbb\",\"background-clip\":\"padding-box\",\"margin\":\"0\",\"padding-left\":\"5px\",\"padding-right\":\"5px\",\"color\":\"#333\",\"font-size\":\"9px\",\"font-family\":\"\\\"Helvetica Neue\\\", Arial, Helvetica, sans-serif\",\"text-align\":\"left\",\"z-index\":\"700\"});\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script><p>Mind you that this <code>sf data.frame</code> must have a few
mandatory columns:</p>
<ul>
<li>
<code>"poly_id"</code>: a unique id for each polygon</li>
<li>
<code>"scale"</code>: the speed scaling factor for each polygon.
Notice that this parameter only works with relative speed factors so
that <code>percentage_mode = TRUE</code> always.</li>
<li>
<code>"priority"</code>: a number ranking which polygon should be
considered in case of overlapping polygons.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">congestion_poly</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 2 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -51.24537 ymin: -30.04352 xmax: -51.21426 ymax: -30.02548</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;   poly_id scale priority                       geometry</span></span>
<span><span class="co">#&gt; 1       1   0.7        1 POLYGON ((-51.22463 -30.034...</span></span>
<span><span class="co">#&gt; 2       2   0.8        2 POLYGON ((-51.21426 -30.034...</span></span></code></pre></div>
<p>In this example, we are simularing a higher congestion level of the
roads in the city center, which would be running at 70% of the legal
speed limit, and a slightly better performance for the roads in the
second polygon, running at 80% of the speed limit. Finally, we can set
<code>default_speed = 0.95</code> to simulate that all other roads in
the city would be running at 95%.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r5r_network_congested_areas</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">congestion_poly</span>,</span>
<span>  default_speed <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And that’s it!</p>
<div class="section level4">
<h4 id="cleaning-up-after-usage">Cleaning up after usage<a class="anchor" aria-label="anchor" href="#cleaning-up-after-usage"></a>
</h4>
<p><code>r5r</code> objects are still allocated to any amount of memory
previously set after they are done with their calculations. In order to
remove an existing <code>r5r</code> object and reallocate the memory it
had been using, we use the <code>stop_r5</code> function followed by a
call to Java’s garbage collector, as follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># stop an specific r5r network</span></span>
<span><span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/stop_r5.html">stop_r5</a></span><span class="op">(</span><span class="va">r5r_network_congestion1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># or stop all r5r networks at once</span></span>
<span><span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/stop_r5.html">stop_r5</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">rJava</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rJava/man/jgc.html" class="external-link">.jgc</a></span><span class="op">(</span>R.gc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>If you have any suggestions or want to report an error, please visit
<a href="https://github.com/ipeaGIT/r5r" class="external-link">the package GitHub
page</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marcus Saraiva, Rafael H. M. Pereira, Daniel Herszenhut, Alex Magnus, Matthew Wigginton Bhagat-Conway, Ipea - Institute for Applied Economic Research, Department of Geography &amp; Planning, University of Toronto.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
