<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building a custom network with modified OSM car speeds • r5r</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building a custom network with modified OSM car speeds">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">r5r</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.2.0999999</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/r5r.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/accessibility.html">Accessibility</a></li>
    <li><a class="dropdown-item" href="../articles/build_custom_network.html">Building a custom network with modified OSM car speeds</a></li>
    <li><a class="dropdown-item" href="../articles/detailed_itineraries.html">Trip planning with detailed_itineraries()</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ - Frequently Asked Questions</a></li>
    <li><a class="dropdown-item" href="../articles/fare_structure.html">Accounting for monetary costs</a></li>
    <li><a class="dropdown-item" href="../articles/isochrones.html">Isochrones</a></li>
    <li><a class="dropdown-item" href="../articles/pareto_frontier.html">Trade-offs between travel time and monetary cost</a></li>
    <li><a class="dropdown-item" href="../articles/time_window.html">Using the time_window parameter</a></li>
    <li><a class="dropdown-item" href="../articles/travel_time_matrix.html">Travel time matrices</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ipeaGIT/r5r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Building a custom network with modified OSM car speeds</h1>
            
            <h4 data-toc-skip class="date">2025-07-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ipeaGIT/r5r/blob/master/vignettes/build_custom_network.Rmd" class="external-link"><code>vignettes/build_custom_network.Rmd</code></a></small>
      <div class="d-none name"><code>build_custom_network.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette shows how to build a custom transport network with
      modified OSM car speeds, which can be used to simulate different
      scenarios of traffic congestion and road closures.
    </div>
    
<div class="section level2">
<h2 id="introduction">1. Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>By default, routing by car in <code>R5</code> considers that vehicles
travel at the legal speed limit in each OSM road edge. This is commonly
referred to as a “free flow scenario”, without congestion. However, the
average speed of car trips is different (usually lower) than the legal
speed limit in most real case scenarios due to traffic conditions and
driving behavior.</p>
<p>This vignette shows how you can set custom speeds for cars by making
simple changes to OSM data with the convenient
<code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> function. We’ll show how OSM speeds
can be changed using two different strategies: (1) by applying different
speed factors by road hierarchy, and (2) by changing the same speed
factor to all roads. A third scenario would be to change the speed of
only the roads within determined areas/polygons, but we’ll leave this
for a future occasion.</p>
<div class="section level3">
<h3 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h3>
<p>The <code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> has a relatively similar
behavior to the <code><a href="../reference/build_network.html">r5r::build_network()</a></code> function. It builds a
transport network that can be used in the routing and accessibility
function in <code>r5r</code>. The two key differences here are:</p>
<ol style="list-style-type: decimal">
<li>The user needs to pass a directory path where the new transport
network is going to be saved. By default,
<code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> builds the new network in a
temporary directory, but users can point to a permanent directory using
the <code>output_dir</code> parameter.</li>
<li>The user needs to point to pass to the <code>new_carspeeds</code>
parameter a <code>data.frame</code> that indicates the speed factor for
each OSM edge id.</li>
</ol>
<p>In this first example we’ll be using the a sample data set for the
city of Porto Alegre (Brazil) included in <code>r5r</code>. This sample
data path includes the file <code>"poa_osm_congestion.csv"</code>, which
should have two columns: <code>"osm_id"</code> and
<code>"max_speed"</code>. Like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># increase Java memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>java.parameters <span class="op">=</span> <span class="st">"-Xmx2G"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ipeaGIT/r5r" class="external-link">r5r</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># data path where the .pbf file is located</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read data.frame with speed factors</span></span>
<span><span class="va">speed_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa/poa_osm_congestion.csv"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">speed_factors</span><span class="op">)</span></span>
<span><span class="co">#&gt;      osm_id max_speed</span></span>
<span><span class="co">#&gt; 1  27184648       0.5</span></span>
<span><span class="co">#&gt; 2 762361901       0.5</span></span>
<span><span class="co">#&gt; 3 568609955       0.5</span></span>
<span><span class="co">#&gt; 4 709834913       0.5</span></span>
<span><span class="co">#&gt; 5 709834914       0.5</span></span>
<span><span class="co">#&gt; 6  77705540       0.5</span></span></code></pre></div>
<p>In this example, the values of the <code>"max_speed"</code> column in
the <code>speed_factors</code> object are all set to <code>0.5</code>.
Since we also set the parameter <code>percentage_mode = TRUE</code>,
this means that the driving speed of those OSM edges listed in the
<code>data.frame</code> will be at 50% of the original speed in the OSM
data. Mind you that the values in the <code>"max_speed"</code> column
also accept absolute values in Km/h, in which case you must use
<code>percentage_mode = FALSE</code>.</p>
<p>obs. by default, the speeds of all the OSM edges not listed in the
<code>data.frame</code> are kept unchanged. You can change the default
value, as we’ll see in the second example below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r5r_network_congestion</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">speed_factors</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And that’s it ! You can now use the new network
<code>r5r_network_congestion</code> in any of <code>r5r</code>’s routing
and accessibility functions, like this.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load origin/destination points</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"poa_points_of_interest.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ttm_congestion</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/travel_time_matrix.html">travel_time_matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">r5r_network_congestion</span>,</span>
<span>  origins <span class="op">=</span> <span class="va">points</span>,</span>
<span>  destinations <span class="op">=</span> <span class="va">points</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">'car'</span>,</span>
<span>  departure_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_trip_duration <span class="op">=</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Obs. Mind you however that, even though we have set the speed factors
to <code>0.5</code>, travel times might not become twice as long. This
is because of how travel times by car are also affected by
intersections, and how changes in the road speeds might also affect the
route and hence the trip distance itself.</p>
<p>Now let’s dive into more realistic examples.</p>
</div>
</div>
<div class="section level2">
<h2 id="setting-different-congestion-levels-by-road-hierarchy">2. Setting different congestion levels by road hierarchy<a class="anchor" aria-label="anchor" href="#setting-different-congestion-levels-by-road-hierarchy"></a>
</h2>
<p>In this example, we’ll set different speed factor for roads of
different hierarchy levels. We can assume for example that congestion
levels tend to be more intense in roads of higher hierarchy. We can do
this in two simple steps.</p>
<p>First we need to do read the OSM data from our <code>.pbf</code>
file, and to filter the OSM edges with the road types we want.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># path to OSM pbf</span></span>
<span><span class="va">pbf_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"/poa_osm.pbf"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># read layer of lines from pbf</span></span>
<span><span class="va">roads</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="va">pbf_path</span>, </span>
<span>  layer <span class="op">=</span> <span class="st">'lines'</span>, </span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter only road types of interest</span></span>
<span><span class="va">rt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"motorway"</span>, <span class="st">"primary"</span>, <span class="st">"secondary"</span>, <span class="st">"tertiary"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">roads</span> <span class="op">&lt;-</span> <span class="va">roads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">osm_id</span>, <span class="va">highway</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">highway</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">rt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">roads</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -51.21315 ymin: -30.06624 xmax: -51.15025 ymax: -30.04939</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;     osm_id highway                       geometry</span></span>
<span><span class="co">#&gt; 1 26786712 primary LINESTRING (-51.15164 -30.0...</span></span>
<span><span class="co">#&gt; 2 26786730 primary LINESTRING (-51.17265 -30.0...</span></span>
<span><span class="co">#&gt; 3 26786732 primary LINESTRING (-51.15025 -30.0...</span></span>
<span><span class="co">#&gt; 4 26847798 primary LINESTRING (-51.21315 -30.0...</span></span>
<span><span class="co">#&gt; 5 26936215 primary LINESTRING (-51.20818 -30.0...</span></span>
<span><span class="co">#&gt; 6 26936224 primary LINESTRING (-51.20818 -30.0...</span></span></code></pre></div>
<p>Here’s how the road network looks like.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># map</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">roads</span><span class="op">[</span><span class="st">"highway"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="build_custom_network_files/figure-html/unnamed-chunk-6-1.png" width="100%"></p>
<p>Now we only need to add a new column <code>"max_speed"</code> with
values conditioned on the road type, and make sure the
<code>osm_id</code> is of class <code>numeric</code>. The
<code>data.frame</code> looks like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_speeds</span> <span class="op">&lt;-</span> <span class="va">roads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    osm_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">osm_id</span><span class="op">)</span>,</span>
<span>    max_speed <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"motorway"</span>  <span class="op">~</span> <span class="fl">0.75</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"primary"</span>   <span class="op">~</span> <span class="fl">0.8</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"secondary"</span> <span class="op">~</span> <span class="fl">0.85</span>,</span>
<span>      <span class="va">highway</span> <span class="op">==</span> <span class="st">"tertiary"</span>  <span class="op">~</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">new_speeds</span><span class="op">)</span></span>
<span><span class="co">#&gt;     osm_id highway max_speed</span></span>
<span><span class="co">#&gt; 1 26786712 primary       0.8</span></span>
<span><span class="co">#&gt; 2 26786730 primary       0.8</span></span>
<span><span class="co">#&gt; 3 26786732 primary       0.8</span></span>
<span><span class="co">#&gt; 4 26847798 primary       0.8</span></span>
<span><span class="co">#&gt; 5 26936215 primary       0.8</span></span>
<span><span class="co">#&gt; 6 26936224 primary       0.8</span></span></code></pre></div>
<p>That’s it. Now we can pass the <code>new_speeds</code> data frame to
<code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> along with the path to the directory
where the original OSM <code>.pbf</code> file is stored and the function
will build a new routable transport network with modified OSM car
speeds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">r5r_network_new_speeds</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">new_speeds</span>,</span>
<span>  output_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="applying-the-same-speed-factor-to-all-roads">3. Applying the same speed factor to all roads<a class="anchor" aria-label="anchor" href="#applying-the-same-speed-factor-to-all-roads"></a>
</h2>
<p>The <code><a href="../reference/build_custom_network.html">build_custom_network()</a></code> function has a parameter
<code>default_speed</code>, which can be used to set the speed of all
the roads not listed in the <code>new_carspeeds</code> input. By
default, <code>default_speed = NULL</code> and the speeds of the
unlisted roads are kept unchanged.</p>
<p>In this example, we’ll use this parameter to apply the same speed
factor to all roads, to simulate as if the speed limits of all roads was
changed to 40 Km/h. To do this, we only need to create a
<code>data.frame</code> with a mock OSM id that that does not exist in
our OSM data and to pass <code>default_speed = 40</code> with
<code>percentage_mode = FALSE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create df with a road that does not exist.</span></span>
<span><span class="va">mock_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>osm_id <span class="op">=</span> <span class="fl">9999</span>, max_speed <span class="op">=</span> <span class="fl">9999</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a temp dir where the custom network will be saved</span></span>
<span><span class="va">new_temp_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span>tmpdir<span class="op">=</span><span class="st">'./40kmph'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">new_temp_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build network with all roads at at 40 Km/h </span></span>
<span><span class="va">r5r_network_20kmph</span> <span class="op">&lt;-</span> <span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/build_custom_network.html">build_custom_network</a></span><span class="op">(</span></span>
<span>  data_path <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>  new_carspeeds <span class="op">=</span> <span class="va">mock_data</span>,</span>
<span>  output_path <span class="op">=</span> <span class="va">new_temp_dir</span>,</span>
<span>  default_speed <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  percentage_mode <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="congestion-level-within-a-polygon">4. Congestion level within a polygon<a class="anchor" aria-label="anchor" href="#congestion-level-within-a-polygon"></a>
</h2>
<p>steps TODO:</p>
<ul>
<li>create a custom polygon, e.g. a circle over the city center</li>
<li>determine OSM ids in the polygon using a spatial join operation
between the polygon and the <code>.pbf</code>
</li>
<li>create a csv file with custom speeds for OSM ids within the
polygon</li>
</ul>
<p>this can be computationally intensive due to the spatial join
operation, depending on the size of the road network and the number of
polygons. A new function under development will make this much easier /
faster.</p>
</div>
<div class="section level2">
<h2 id="extra-tip">Extra tip:<a class="anchor" aria-label="anchor" href="#extra-tip"></a>
</h2>
<ul>
<li>
<strong>Road closure</strong>: one can simulate a road closure by
setting the <code>"max_speed"</code> value to <code>0</code>. This can
be quite handy for studies that try to measure the resilience of
transport systems to network disruptions.</li>
</ul>
<div class="section level4">
<h4 id="cleaning-up-after-usage">Cleaning up after usage<a class="anchor" aria-label="anchor" href="#cleaning-up-after-usage"></a>
</h4>
<p><code>r5r</code> objects are still allocated to any amount of memory
previously set after they are done with their calculations. In order to
remove an existing <code>r5r</code> object and reallocate the memory it
had been using, we use the <code>stop_r5</code> function followed by a
call to Java’s garbage collector, as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/stop_r5.html">stop_r5</a></span><span class="op">(</span><span class="va">r5r_network_congestion</span><span class="op">)</span></span>
<span><span class="fu">rJava</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rJava/man/jgc.html" class="external-link">.jgc</a></span><span class="op">(</span>R.gc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>If you have any suggestions or want to report an error, please visit
<a href="https://github.com/ipeaGIT/r5r" class="external-link">the package GitHub
page</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marcus Saraiva, Rafael H. M. Pereira, Daniel Herszenhut, Alex Magnus, Matthew Wigginton Bhagat-Conway, Ipea - Institute for Applied Economic Research, Department of Geography &amp; Planning, University of Toronto.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
