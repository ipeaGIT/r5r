<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Accounting for monetary costs • r5r</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Accounting for monetary costs">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">r5r</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/r5r.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/accessibility.html">Accessibility</a></li>
    <li><a class="dropdown-item" href="../articles/detailed_itineraries.html">Trip planning with detailed_itineraries()</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ - Frequently Asked Questions</a></li>
    <li><a class="dropdown-item" href="../articles/fare_structure.html">Accounting for monetary costs</a></li>
    <li><a class="dropdown-item" href="../articles/isochrones.html">Isochrones</a></li>
    <li><a class="dropdown-item" href="../articles/pareto_frontier.html">Trade-offs between travel time and monetary cost</a></li>
    <li><a class="dropdown-item" href="../articles/time_window.html">Using the time_window parameter</a></li>
    <li><a class="dropdown-item" href="../articles/travel_time_matrix.html">Travel time matrices</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ipeaGIT/r5r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Accounting for monetary costs</h1>
            
            <h4 data-toc-skip class="date">2025-01-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ipeaGIT/r5r/tree/master/r-package/vignettes/fare_structure.Rmd" class="external-link"><code>vignettes/fare_structure.Rmd</code></a></small>
      <div class="d-none name"><code>fare_structure.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette shows how to configure and use custom fare rules in
      order to account for monetary travel costs when generating travel
      time matrices and accessibility estimates with the
      <code>r5r</code> package.
    </div>
    
<div class="section level2">
<h2 id="introduction">1. Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Considering the monetary costs of public transport trips in the
calculation of travel time matrices and accessibility estimates is a
major challenge faced by researchers and planning practitioners. Each
public transport system can have its own set of rules for calculating
fares, with varying levels of complexity. Moreover, there are important
trade offs between travel time and monetary costs across multiple trip
alternatives and are currently not captured by any multimodal routing
engine, except for R5.</p>
<p>R5 has native capabilities and an open architecture for creating and
including fare structures in routing models, making it possible to
estimate travel time matrices and accessibility estimates simultaneously
considering different combinations of time and monetary cost cutoffs.
The main challenge, however, is that a specific fare structure for each
city needs to be programmed in Java and tightly integrated into R5,
making this functionality out of reach for those who do not know how to
code in Java (i.e. most of us!).</p>
<p>To help tackle this challenge, <code>r5r</code> has a simple generic
rule-based fare structure that can be configured via a predefined set of
properties and rules that can be set directly from R or using external
tools such as text editors and spreadsheets. This approach currently
available in <code>r5r</code> is able to account for the monetary costs
of public transport systems that follow a simple set of fare rules
according to which the cost of a journey depends on combinations of
modes (see details below).</p>
<p><strong>This vignette shows the features of <code>r5r</code>s fare
structure. It also uses a reproducible example to demonstrate how to
configure the fare structure to account for monetary costs when
generating travel time matrices and accessibility estimates with
<code>r5r</code></strong>.</p>
<div class="section level3">
<h3 id="details">1.1 Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h3>
<p>A common feature among many public transport services is the
possibility of discounted transfers, when passengers can use a single
ticket for a trip composed of multiple rides sometimes combining
different transport modes. Such trips usually come with a discount in
the second or subsequent fares, as well as a limit on the number of
discounted transfers the user can make and/or a time limit for using
that discount. This is the type of fare structure currently covered by
<code>r5r</code>.</p>
<p>We acknowledge that there are several types fare rules that vary from
one public transport system to another. According to these rules, the
cost of a journey can differ, for example, depending on: different costs
for each trip leg, transport mode or route; distance- or zone-based
fares; different fares for types of riders (e.g elderly people or
students) or time of the day (e.g. peak and off-peak hours); among many
others rules. As such, taking all of these possible rules into
consideration when calculating the monetary cost of multimodal can be
quite difficult. <code>r5r</code> currently does not cover these more
complex fare rules.</p>
<p>The fare calculator currently available in <code>r5r</code> is not
intended to be a robust solution that can take into consideration all
public transport systems and their specific fare rules. That would be a
Herculean task. The features included in <code>r5r</code>’s fare
calculator are inspired by our empirical observations of Brazilian
public transport systems, and is meant to be used mainly in the <a href="https://www.ipea.gov.br/acessooportunidades/en/" class="external-link">Access to
Opportunities project</a>. Everyone else is welcome to use it, if the
current features suit their needs.</p>
<p>obs. The GTFS format has some features for specifying public
transport fares, but those features are quite limited and are not enough
for adequately representing many use cases. A new version of that
specification is currently being developed <a href="https://github.com/google/transit/issues/252" class="external-link">Fares V2</a>, but it
may take some time for it to be approved and for transport agencies
actually start providing GTFS feeds with full fare information.</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="reprex-the-public-transport-system-of-porto-alegre">2. Reprex: the public transport system of Porto Alegre<a class="anchor" aria-label="anchor" href="#reprex-the-public-transport-system-of-porto-alegre"></a>
</h2>
<p>In this vignette, we will be using the sample data set for the city
of Porto Alegre (Brazil) included in <code>r5r</code>. Before we start,
we need to increase the memory available to Java and load the packages
used in this vignette</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>java.parameters <span class="op">=</span> <span class="st">"-Xmx2G"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ipeaGIT/r5r" class="external-link">r5r</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://obrl-soil.github.io/h3jsr/" class="external-link">h3jsr</a></span><span class="op">)</span></span></code></pre></div>
<p>Porto Alegre has a relatively straightforward public transport
system, where the vast majority of the population that rely on transit
ride buses. The city also has a metropolitan rail service that connects
the city center to the neighboring northbound municipalities. That
system can be seen in the map below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setup and load Porto Alegre multimodal network into memory</span></span>
<span></span>
<span><span class="co"># system.file returns the directory with example data inside the r5r package</span></span>
<span><span class="co"># set data path to directory containing your own data if not using the examples</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r5r_core</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_r5.html">setup_r5</a></span><span class="op">(</span><span class="va">data_path</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using cached R5 version from C:\Users\B14912846767\AppData\Local/R/cache/R/r5r/r5_jar_v7.1.0/r5-v7.1-all.jar</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Using cached network.dat from C:/Users/B14912846767/AppData/Local/Programs/R/R-4.4.2/library/r5r/extdata/poa/network.dat</span></span>
<span></span>
<span><span class="co"># load transit network as an SF</span></span>
<span><span class="va">transit_network</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transit_network_to_sf.html">transit_network_to_sf</a></span><span class="op">(</span><span class="va">r5r_core</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># map</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">transit_network</span><span class="op">$</span><span class="va">routes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">mode</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="fare_structure_files/figure-html/unnamed-chunk-3-1.png" width="100%"></p>
<p>According to the fare rules in Porto Alegre, as in most Brazilian
cities, the cost a a journey depends on a combination of number of
subsequent trips and/or transport modes. In the case of Porto Alegre,
the fare rules are as follows:</p>
<ul>
<li>Each bus ticket costs R$ 4.80.</li>
<li>Riding a second bus adds R$ 2.40 to the total cost. Subsequent bus
rides cost the full ticket price of R$ 4.80.</li>
<li>Each train ticket costs R$ 4.50. Once a passenger enters a train
station, she can take an unlimited amount of train trips as long as she
doesn’t leave a station.</li>
<li>The integrated fare between bus and train has a 10% discount, which
totals R$ 8.37.</li>
</ul>
<p>In the following sections, we will demonstrate how to implement those
rules within r5r’s fare calculator.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="setting-up-the-fare-structure">3. Setting up the fare structure<a class="anchor" aria-label="anchor" href="#setting-up-the-fare-structure"></a>
</h2>
<p>There are three support functions in <code>r5r</code> to help users
configure the fare structure:</p>
<ul>
<li>
<code><a href="../reference/setup_fare_structure.html">setup_fare_structure()</a></code> analyses the study area’s GTFS
and builds a ‘skeleton’ fare structure structure with the parameters
that need to be set;</li>
<li>
<code><a href="../reference/write_fare_structure.html">write_fare_structure()</a></code> and
<code><a href="../reference/read_fare_structure.html">read_fare_structure()</a></code> allow saving the current fare
structure settings to disk, and reading them back into memory. The
settings are saved as standard <code>.csv</code> files inside a zipped
folder. These files can be edited outside the R session using external
text editors and spreadsheet software, for user’s convenience.</li>
</ul>
<p>First, we need to call <code><a href="../reference/setup_fare_structure.html">setup_fare_structure()</a></code>, providing
three parameters: the current <code>r5r_core</code> object, a
<code>base_fare</code> used to populate the fare structure, and the
<code>by</code> parameters that identifies what is the main property of
the route that defines the different fares.</p>
<p>In the example below, the <code>base_fare</code> is the standard bus
ticket price of R$ 4.80. We are also stating that
<code>by = "MODE"</code>, so that each transport mode has its own fares
and integration rules. Users can also create a fare structure where fare
rules of routes differ by <code>"AGENCY_ID"</code> or
<code>"AGENCY_NAME"</code>, or simply set <code>by = "GENERIC"</code>
when the entire system follows the same rules.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_fare_structure.html">setup_fare_structure</a></span><span class="op">(</span><span class="va">r5r_core</span>, </span>
<span>                                       base_fare <span class="op">=</span> <span class="fl">4.8</span>,</span>
<span>                                       by <span class="op">=</span> <span class="st">"MODE"</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s check the contents of the <code>fare_structure</code>
object. We can see below that it is simply a <code>list</code> with a
few properties and data.frames.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fare_structure</span>, n<span class="op">=</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="co">#&gt; $max_discounted_transfers</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $transfer_time_allowance</span></span>
<span><span class="co">#&gt; [1] 120</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fare_cap</span></span>
<span><span class="co">#&gt; [1] Inf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fares_per_type</span></span>
<span><span class="co">#&gt;      type unlimited_transfers allow_same_route_transfer use_route_fare  fare</span></span>
<span><span class="co">#&gt;    &lt;char&gt;              &lt;lgcl&gt;                    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    BUS               FALSE                     FALSE          FALSE   4.8</span></span>
<span><span class="co">#&gt; 2:   RAIL               FALSE                     FALSE          FALSE   4.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fares_per_transfer</span></span>
<span><span class="co">#&gt;    first_leg second_leg  fare</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       BUS        BUS   4.8</span></span>
<span><span class="co">#&gt; 2:      RAIL        BUS   4.8</span></span>
<span><span class="co">#&gt; 3:       BUS       RAIL   4.8</span></span>
<span><span class="co">#&gt; 4:      RAIL       RAIL   4.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fares_per_route</span></span>
<span><span class="co">#&gt;      agency_id                                 agency_name  route_id</span></span>
<span><span class="co">#&gt;         &lt;char&gt;                                      &lt;char&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt;   1:      EPTC Empresa Publica de Transportes e Circulação      1112</span></span>
<span><span class="co">#&gt;   2:      EPTC Empresa Publica de Transportes e Circulação       149</span></span>
<span><span class="co">#&gt;   3:      EPTC Empresa Publica de Transportes e Circulação       165</span></span>
<span><span class="co">#&gt;   4:      EPTC Empresa Publica de Transportes e Circulação       168</span></span>
<span><span class="co">#&gt;   5:      EPTC Empresa Publica de Transportes e Circulação       173</span></span>
<span><span class="co">#&gt;  ---                                                                </span></span>
<span><span class="co">#&gt; 113:      EPTC Empresa Publica de Transportes e Circulação        T9</span></span>
<span><span class="co">#&gt; 114:      EPTC Empresa Publica de Transportes e Circulação      TR60</span></span>
<span><span class="co">#&gt; 115:      EPTC Empresa Publica de Transportes e Circulação      TR62</span></span>
<span><span class="co">#&gt; 116:     TRENS                                    TRENSURB    LINHA1</span></span>
<span><span class="co">#&gt; 117:     TRENS                                    TRENSURB LINHAAERO</span></span>
<span><span class="co">#&gt;      route_short_name                           route_long_name   mode</span></span>
<span><span class="co">#&gt;                &lt;char&gt;                                    &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt;   1:             1112                         HIPICA / TRISTEZA    BUS</span></span>
<span><span class="co">#&gt;   2:              149                                    ICARAI    BUS</span></span>
<span><span class="co">#&gt;   3:              165                                     COHAB    BUS</span></span>
<span><span class="co">#&gt;   4:              168                  BELEM NOVO(VIA TRISTEZA)    BUS</span></span>
<span><span class="co">#&gt;   5:              173                                   CAMAQUA    BUS</span></span>
<span><span class="co">#&gt;  ---                                                                  </span></span>
<span><span class="co">#&gt; 113:               T9                                       PUC    BUS</span></span>
<span><span class="co">#&gt; 114:             TR60                         TRONCAL TRI‘NGULO    BUS</span></span>
<span><span class="co">#&gt; 115:             TR62                          TRONCAL BALTAZAR    BUS</span></span>
<span><span class="co">#&gt; 116:           LINHA1 ESTACAO MERCADO ATE ESTACAO NOVO HAMBURGO   RAIL</span></span>
<span><span class="co">#&gt; 117:             AREO                        AEROMOVEL TRENSURB   RAIL</span></span>
<span><span class="co">#&gt;      route_fare fare_type</span></span>
<span><span class="co">#&gt;           &lt;num&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt;   1:        4.8       BUS</span></span>
<span><span class="co">#&gt;   2:        4.8       BUS</span></span>
<span><span class="co">#&gt;   3:        4.8       BUS</span></span>
<span><span class="co">#&gt;   4:        4.8       BUS</span></span>
<span><span class="co">#&gt;   5:        4.8       BUS</span></span>
<span><span class="co">#&gt;  ---                     </span></span>
<span><span class="co">#&gt; 113:        4.8       BUS</span></span>
<span><span class="co">#&gt; 114:        4.8       BUS</span></span>
<span><span class="co">#&gt; 115:        4.8       BUS</span></span>
<span><span class="co">#&gt; 116:        4.8      RAIL</span></span>
<span><span class="co">#&gt; 117:        4.8      RAIL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $debug_settings</span></span>
<span><span class="co">#&gt; $debug_settings$output_file</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $debug_settings$trip_info</span></span>
<span><span class="co">#&gt; [1] "MODE"</span></span></code></pre></div>
<div class="section level3">
<h3 id="global-properties">3.1 Global Properties<a class="anchor" aria-label="anchor" href="#global-properties"></a>
</h3>
<p>Let’s configure the global properties first, which are the ones that
are applied to the entire system.</p>
<div class="section level4">
<h4 id="max_discounted_transfers">
<code>max_discounted_transfers</code><a class="anchor" aria-label="anchor" href="#max_discounted_transfers"></a>
</h4>
<p>Note that <code>max_discounted_transfers</code> is set to 1 by
default. This means that the passenger gets a fare discount in the first
transfer between buses, but she would pay the full fare price in
subsequent transfers.</p>
</div>
<div class="section level4">
<h4 id="transfer_time_allowance">
<code>transfer_time_allowance</code><a class="anchor" aria-label="anchor" href="#transfer_time_allowance"></a>
</h4>
<p>By default, <code>transfer_time_allowance</code> is set to 120
minutes. We have to set it to 60 minutes to fit our use case (passengers
have 60 minutes to take the second bus on a discounted fare, otherwise a
full fare is charged).</p>
</div>
<div class="section level4">
<h4 id="fare_cap">
<code>fare_cap</code><a class="anchor" aria-label="anchor" href="#fare_cap"></a>
</h4>
<p>Finally, the <code>fare_cap</code> setting indicates if there is a
maximum value that can be charged in a trip, beyond which all subsequent
rides are free of charge. In this example, we can leave
<code>fare_cap</code> set to its default <code>Inf</code> value because
this feature is not applicable to Porto Alegre.</p>
<p>Here is how we can check or update the values of these
components:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">max_discounted_transfers</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">transfer_time_allowance</span> <span class="op">&lt;-</span> <span class="fl">60</span> <span class="co"># update transfer_time_allowance</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fare_cap</span></span>
<span><span class="co">#&gt; [1] Inf</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="configure-fares-by-transport-mode">3.2 Configure fares by transport mode<a class="anchor" aria-label="anchor" href="#configure-fares-by-transport-mode"></a>
</h3>
<p>To configure mode-, transfer-, and route-specific properties, we can
use the three <code>data.frames</code> inside our
<code>fare_structure</code> list. Let’s configure the modes first.
Below, we can see that the <code>fares_per_type</code> data.frame
contains five columns:</p>
<ul>
<li>
<code>mode</code>: the transport mode to which rules on each row
refer to;</li>
<li>
<code>unlimited_transfers</code>: a logical value <code>TRUE</code>
or <code>FALSE</code> that indicates if that transport mode allows
unlimited transfers between trips of the same mode, such as a
metro/subway system where the passenger pays a fare to access a station
and then can use as many services as she wants as long as she doesn’t
exit the system;</li>
<li>
<code>allow_same_route_transfer</code>: a logical value indicating
if a discounted transfer can be done between vehicles ??? of the same
route;</li>
<li>
<code>use_route_fare</code>: another logical value that indicates if
each route will have its own fare, or if all routes in this mode will
use the fare indicated in this table;</li>
<li>
<code>fare</code>: the full fare price of this mode.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_type</span></span>
<span><span class="co">#&gt;      type unlimited_transfers allow_same_route_transfer use_route_fare  fare</span></span>
<span><span class="co">#&gt;    &lt;char&gt;              &lt;lgcl&gt;                    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    BUS               FALSE                     FALSE          FALSE   4.8</span></span>
<span><span class="co">#&gt; 2:   RAIL               FALSE                     FALSE          FALSE   4.8</span></span></code></pre></div>
<p>We need to do a few small changes in the <code>fares_per_type</code>
table to accomodate the fare rules of Porto Alegre. In the
<code>"RAIL"</code> mode, we need to set
<code>unlimited_transfers</code> and
<code>allow_same_route_transfer</code> to <code>TRUE</code>, and update
<code>fare</code> to 4.50. In the <code>"BUS"</code> mode, we can let
the <code>allow_same_route_transfer</code> set to its default
<code>FALSE</code> value, because even though there is a discount for
transfers between buses (which is set in the following section), that
discount is not valid when transferring between buses within the same
route (for example, from bus route T1 to another T1). We’ll do those
changes below, using <code>data.table</code> notation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_type</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"RAIL"</span>, <span class="va">unlimited_transfers</span> <span class="op">:=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_type</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"RAIL"</span>, <span class="va">fare</span> <span class="op">:=</span> <span class="fl">4.50</span><span class="op">]</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_type</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"RAIL"</span>, <span class="va">allow_same_route_transfer</span> <span class="op">:=</span> <span class="cn">TRUE</span><span class="op">]</span></span></code></pre></div>
<p>Checking the results below, everything looks OK:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_type</span></span>
<span><span class="co">#&gt; Index: &lt;type&gt;</span></span>
<span><span class="co">#&gt;      type unlimited_transfers allow_same_route_transfer use_route_fare  fare</span></span>
<span><span class="co">#&gt;    &lt;char&gt;              &lt;lgcl&gt;                    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    BUS               FALSE                     FALSE          FALSE   4.8</span></span>
<span><span class="co">#&gt; 2:   RAIL                TRUE                      TRUE          FALSE   4.5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="configure-fares-by-transfers">3.3 Configure fares by transfers<a class="anchor" aria-label="anchor" href="#configure-fares-by-transfers"></a>
</h3>
<p>The fare rules for transfer are stored in the
<code>fares_per_transfer</code> data.frame, which is shown below. Each
row contains the fare prices for transfers between the modes specified
in <code>first_leg</code> and <code>second_leg</code> columns.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span></span>
<span><span class="co">#&gt;    first_leg second_leg  fare</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       BUS        BUS   4.8</span></span>
<span><span class="co">#&gt; 2:      RAIL        BUS   4.8</span></span>
<span><span class="co">#&gt; 3:       BUS       RAIL   4.8</span></span>
<span><span class="co">#&gt; 4:      RAIL       RAIL   4.8</span></span></code></pre></div>
<p>Let’s update <code>fare_per_transfer</code> to account for the actual
integration rules in Porto Alegre.</p>
<ul>
<li>The fare for “BUS” to “BUS” integration is composed of 4.80 for the
first leg plus 2.40 for the second leg, which equals to a total fare of
7.20.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># conditional update fare value</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span><span class="op">[</span><span class="va">first_leg</span> <span class="op">==</span> <span class="st">"BUS"</span> <span class="op">&amp;</span> <span class="va">second_leg</span> <span class="op">==</span> <span class="st">"BUS"</span>, <span class="va">fare</span> <span class="op">:=</span> <span class="fl">7.2</span><span class="op">]</span></span></code></pre></div>
<ul>
<li>Transfers between “BUS” and “RAIL” (in any direction) cost 8.37,
once the 10% discount is applied. Let’s make a final update in the
data.frame to account for that.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># conditional update fare value</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span><span class="op">[</span><span class="va">first_leg</span> <span class="op">!=</span> <span class="va">second_leg</span>, <span class="va">fare</span> <span class="op">:=</span> <span class="fl">8.37</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># use fcase instead ?</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span><span class="op">[</span>, <span class="va">fare</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fcase.html" class="external-link">fcase</a></span><span class="op">(</span><span class="va">first_leg</span> <span class="op">==</span> <span class="st">"BUS"</span> <span class="op">&amp;</span> <span class="va">second_leg</span> <span class="op">==</span> <span class="st">"BUS"</span>, <span class="fl">7.2</span>,</span>
<span>                                                 <span class="va">first_leg</span> <span class="op">!=</span> <span class="va">second_leg</span>, <span class="fl">8.37</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<ul>
<li>Transfers between “RAIL” and “RAIL” are free and unlimited, which is
already accounted for in the field <code>unlimited_transfers</code> of
the <code>fare_per_mode</code> table. Thus, the equivalent row of the
<code>fare_per_transfer</code> data.frame needs to be removed. If we
leave the that row in <code>fare_per_transfer</code>, transfers between
“RAIL” and “RAIL” will count to the global
<code>max_discounted_transfers</code> allowance.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove row</span></span>
<span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span> <span class="op">&lt;-</span> <span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">first_leg</span> <span class="op">==</span> <span class="st">"RAIL"</span> <span class="op">&amp;</span> <span class="va">second_leg</span> <span class="op">==</span> <span class="st">"RAIL"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Once all changes are applied, the <code>fare_per_transfer</code>
data.frame should look like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_transfer</span></span>
<span><span class="co">#&gt;    first_leg second_leg  fare</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       BUS        BUS  7.20</span></span>
<span><span class="co">#&gt; 2:      RAIL        BUS  8.37</span></span>
<span><span class="co">#&gt; 3:       BUS       RAIL  8.37</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="routes-configuration">3.4 Routes configuration<a class="anchor" aria-label="anchor" href="#routes-configuration"></a>
</h3>
<p>The information on the fare price for each route is stored in the
<code>fares_per_route</code> data.frame. Below, we can see a sample of
the bus and train routes in Porto Alegre. In case there a few special
routes (e.g. express services) with specific fares, these values can be
updated in this <code>fares_per_route</code> data.frame.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">fare_structure</span><span class="op">$</span><span class="va">fares_per_route</span><span class="op">)</span></span>
<span><span class="co">#&gt;    agency_id                                 agency_name  route_id</span></span>
<span><span class="co">#&gt;       &lt;char&gt;                                      &lt;char&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:      EPTC Empresa Publica de Transportes e Circulação        T8</span></span>
<span><span class="co">#&gt; 2:      EPTC Empresa Publica de Transportes e Circulação        T9</span></span>
<span><span class="co">#&gt; 3:      EPTC Empresa Publica de Transportes e Circulação      TR60</span></span>
<span><span class="co">#&gt; 4:      EPTC Empresa Publica de Transportes e Circulação      TR62</span></span>
<span><span class="co">#&gt; 5:     TRENS                                    TRENSURB    LINHA1</span></span>
<span><span class="co">#&gt; 6:     TRENS                                    TRENSURB LINHAAERO</span></span>
<span><span class="co">#&gt;    route_short_name                           route_long_name   mode route_fare</span></span>
<span><span class="co">#&gt;              &lt;char&gt;                                    &lt;char&gt; &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:               T8                       CAMPUS  /  FARRAPOS    BUS        4.8</span></span>
<span><span class="co">#&gt; 2:               T9                                       PUC    BUS        4.8</span></span>
<span><span class="co">#&gt; 3:             TR60                         TRONCAL TRI‘NGULO    BUS        4.8</span></span>
<span><span class="co">#&gt; 4:             TR62                          TRONCAL BALTAZAR    BUS        4.8</span></span>
<span><span class="co">#&gt; 5:           LINHA1 ESTACAO MERCADO ATE ESTACAO NOVO HAMBURGO   RAIL        4.8</span></span>
<span><span class="co">#&gt; 6:             AREO                        AEROMOVEL TRENSURB   RAIL        4.8</span></span>
<span><span class="co">#&gt;    fare_type</span></span>
<span><span class="co">#&gt;       &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:       BUS</span></span>
<span><span class="co">#&gt; 2:       BUS</span></span>
<span><span class="co">#&gt; 3:       BUS</span></span>
<span><span class="co">#&gt; 4:       BUS</span></span>
<span><span class="co">#&gt; 5:      RAIL</span></span>
<span><span class="co">#&gt; 6:      RAIL</span></span></code></pre></div>
<p>Basic route information is taken directly from the GTFS data (agency,
route id and names, mode, etc), but the <code>route_fare</code> and
<code>fare_type</code> columns were added specifically for the
<code>r5r</code> fare structure.</p>
<ul>
<li><p><code>route_fare</code>: is used to set a specific fare for each
route. This field can be used to represent services that have many
unique fares, such as metropolitan / suburban trains and buses. This is
used together with the <code>use_route_fare</code> column in the
<code>fares_per_type</code> table: the <code>route_fare</code> field is
only considered by the <code>r5r</code> fare structure when
<code>use_route_fare</code> of that mode is set to
<code>TRUE</code>.</p></li>
<li><p><code>fare_type</code>: is used to link each route with
information in the <code>fares_per_type</code> and
<code>fares_per_transfer</code> tables. In this example,
<code>fare_type</code> is always the same as <code>mode</code>, because
that was what we chose in the <code>by</code> parameter when calling
<code>setup_fare_structure</code> earlier (we could have chosen to
discriminate fares by agency, for example).</p></li>
</ul>
<p>We actually don’t have any change do to in the
<code>fares_per_route</code> table, in this example. It does not matter
that the <code>route_fare</code> value is wrong for the “RAIL” lines,
because we are using the fares set in <code>fares_per_type</code> and
<code>fares_per_transfer</code> which we already set up correctly
before.</p>
<p>Now that our <code>fare_structure</code> is complete, we can use it
to calculate travel time matrices and accessibility while accounting for
monetary cost cutoffs. Let’s see how it’s done in the next sections.</p>
</div>
</div>
<div class="section level2">
<h2 id="calculating-travel-time-and-accessibiilty-accounting-for-monetary-costs">4. Calculating travel time and accessibiilty accounting for monetary
costs<a class="anchor" aria-label="anchor" href="#calculating-travel-time-and-accessibiilty-accounting-for-monetary-costs"></a>
</h2>
<p>The <code><a href="../reference/travel_time_matrix.html">travel_time_matrix()</a></code> and
<code><a href="../reference/accessibility.html">accessibility()</a></code> functions have two new parameters to
account for monetary costs thresholds:</p>
<ul>
<li>
<code>fare_structure</code>: the settings object that we’ve been
working on.</li>
<li>
<code>max_fare</code>: the maximum total fare that can be used in
the trip.</li>
</ul>
<div class="section level3">
<h3 id="travel-time-with-monetary-cost">4.1 Travel time with monetary cost<a class="anchor" aria-label="anchor" href="#travel-time-with-monetary-cost"></a>
</h3>
<p>The following example shows travel time differences when monetary
costs are accounted for, using the <code><a href="../reference/travel_time_matrix.html">travel_time_matrix()</a></code>
function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load input data</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/poa/poa_hexgrid.csv"</span>, package <span class="op">=</span> <span class="st">"r5r"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate travel times function</span></span>
<span><span class="va">calculate_travel_times</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fare</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ttm_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/travel_time_matrix.html">travel_time_matrix</a></span><span class="op">(</span></span>
<span>    <span class="va">r5r_core</span>,</span>
<span>    origins <span class="op">=</span> <span class="va">points</span>,</span>
<span>    destinations <span class="op">=</span> <span class="va">points</span>,</span>
<span>    mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WALK"</span>, <span class="st">"TRANSIT"</span><span class="op">)</span>,</span>
<span>    departure_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span></span>
<span>      <span class="st">"13-05-2019 14:00:00"</span>,</span>
<span>      format <span class="op">=</span> <span class="st">"%d-%m-%Y %H:%M:%S"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    time_window <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    fare_structure <span class="op">=</span> <span class="va">fare_structure</span>,</span>
<span>    max_fare <span class="op">=</span> <span class="va">fare</span>,</span>
<span>    max_trip_duration <span class="op">=</span> <span class="fl">40</span>,</span>
<span>    max_walk_time <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ttm_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># calculate travel times, and combine results</span></span>
<span><span class="va">ttm</span> <span class="op">&lt;-</span> <span class="fu">calculate_travel_times</span><span class="op">(</span>fare <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required namespace: testthat</span></span>
<span><span class="va">ttm_500</span> <span class="op">&lt;-</span> <span class="fu">calculate_travel_times</span><span class="op">(</span>fare <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merge results</span></span>
<span><span class="va">ttm</span><span class="op">[</span><span class="va">ttm_500</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">from_id</span>, <span class="va">to_id</span><span class="op">)</span>, <span class="va">travel_time_500</span> <span class="op">:=</span> <span class="va">i.travel_time_p50</span><span class="op">]</span></span>
<span><span class="va">ttm</span><span class="op">[</span>, <span class="va">travel_time_unl</span> <span class="op">:=</span> <span class="va">travel_time_p50</span><span class="op">]</span></span>
<span><span class="va">ttm</span><span class="op">[</span>, <span class="va">travel_time_p50</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></code></pre></div>
<p>Below, we can see a sample of the travel time differences with and
without monetary cost restriction. We can see that some trips are not
affected at all (<code>travel_time_unl == travel_time_500</code>), some
trips take a little longer to complete
(<code>travel_time_500 &gt; travel_time_unl</code>), and other trips
cannot be completed at all (<code>travel_time_500 == NA</code>).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">ttm</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;             from_id           to_id travel_time_500 travel_time_unl</span></span>
<span><span class="co">#&gt;              &lt;char&gt;          &lt;char&gt;           &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1: 89a90166da7ffff 89a90129c2bffff              38              36</span></span>
<span><span class="co">#&gt;  2: 89a90166da7ffff 89a90129aa7ffff              33              30</span></span>
<span><span class="co">#&gt;  3: 89a90166da7ffff 89a90e93497ffff              32              32</span></span>
<span><span class="co">#&gt;  4: 89a90166da7ffff 89a90129807ffff              39              38</span></span>
<span><span class="co">#&gt;  5: 89a90166da7ffff 89a90129b5bffff              34              34</span></span>
<span><span class="co">#&gt;  6: 89a90166da7ffff 89a90129dd7ffff              37              37</span></span>
<span><span class="co">#&gt;  7: 89a90166da7ffff 89a90129bbbffff              33              33</span></span>
<span><span class="co">#&gt;  8: 89a90166da7ffff 89a90129bd7ffff              26              26</span></span>
<span><span class="co">#&gt;  9: 89a90166da7ffff 89a90129a47ffff              19              19</span></span>
<span><span class="co">#&gt; 10: 89a90166da7ffff 89a90166da7ffff               0               0</span></span></code></pre></div>
<p>The plots below show the overall distribution of the travel time
differences and unreachable destinations:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot of overall travel time differences between limited and unlimited cost travel time matrices </span></span>
<span><span class="va">time_difference</span> <span class="op">=</span> <span class="va">ttm</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">travel_time_500</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span>count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>, </span>
<span>                      by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">travel_time_unl</span>, <span class="va">travel_time_500</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">time_difference</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">travel_time_unl</span>, x <span class="op">=</span> <span class="va">travel_time_500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"travel time (minutes)\nunestricted monetary cost"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"travel time (minutes)\nmonetary cost restricted to BRL 5.00"</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot of unreachable destinations when the monetary cost limit is too low</span></span>
<span><span class="va">unreachable</span> <span class="op">&lt;-</span> <span class="va">ttm</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">travel_time_unl</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">travel_time_500</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">unreachable</span><span class="op">[</span>, <span class="va">perc</span> <span class="op">:=</span> <span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">travel_time_unl</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">unreachable</span> <span class="op">&lt;-</span> <span class="va">unreachable</span><span class="op">[</span><span class="va">is.na</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="va">unreachable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">unreachable</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">unreachable</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">travel_time_unl</span>, y<span class="op">=</span><span class="va">perc</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, </span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">20</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"travel time (minutes)\nwithout monetary cost restriction"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"% of unreachable destinations\nconsidering a R$ 5.00 monetary cost limit"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine both plots using patchwork</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Comparing travel times with and without monetary cost restriction"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fare_structure_files/figure-html/unnamed-chunk-18-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="calculating-accessibility-with-monetary-cost">4.2 Calculating accessibility with monetary cost<a class="anchor" aria-label="anchor" href="#calculating-accessibility-with-monetary-cost"></a>
</h3>
<p>Now, we can answer questions like “how many health care facilities
one can access in 60 minutes using public transport, on a R$5.00
budget?”. We’ll do that below, and compare the results the accessibility
unconstrained by monetary costs:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate accessibility function</span></span>
<span><span class="va">calculate_accessibility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fare</span>, <span class="va">fare_string</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">access_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accessibility.html">accessibility</a></span><span class="op">(</span></span>
<span>    <span class="va">r5r_core</span>,</span>
<span>    origins <span class="op">=</span> <span class="va">points</span>,</span>
<span>    destinations <span class="op">=</span> <span class="va">points</span>,</span>
<span>    mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WALK"</span>, <span class="st">"TRANSIT"</span><span class="op">)</span>,</span>
<span>    departure_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span></span>
<span>      <span class="st">"13-05-2019 14:00:00"</span>,</span>
<span>      format <span class="op">=</span> <span class="st">"%d-%m-%Y %H:%M:%S"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    time_window <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    opportunities_colname <span class="op">=</span> <span class="st">"healthcare"</span>,</span>
<span>    cutoffs <span class="op">=</span> <span class="fl">40</span>,</span>
<span>    fare_structure <span class="op">=</span> <span class="va">fare_structure</span>,</span>
<span>    max_fare <span class="op">=</span> <span class="va">fare</span>,</span>
<span>    max_trip_duration <span class="op">=</span> <span class="fl">40</span>,</span>
<span>    max_walk_time <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">access_df</span><span class="op">$</span><span class="va">max_fare</span> <span class="op">&lt;-</span> <span class="va">fare_string</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">access_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate accessibility, combine results, and convert to SF</span></span>
<span><span class="va">access_500</span> <span class="op">&lt;-</span> <span class="fu">calculate_accessibility</span><span class="op">(</span>fare<span class="op">=</span><span class="fl">5</span>, fare_string<span class="op">=</span><span class="st">"R$ 5.00 budget"</span><span class="op">)</span></span>
<span><span class="va">access_unl</span> <span class="op">&lt;-</span> <span class="fu">calculate_accessibility</span><span class="op">(</span>fare<span class="op">=</span><span class="cn">Inf</span>, fare_string<span class="op">=</span><span class="st">"Unlimited budget"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">access</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">access_500</span>, <span class="va">access_unl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bring geometry</span></span>
<span><span class="va">access</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="fu">h3jsr</span><span class="fu">::</span><span class="fu"><a href="https://obrl-soil.github.io/h3jsr/reference/cell_to_polygon.html" class="external-link">cell_to_polygon</a></span><span class="op">(</span><span class="va">access</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">access</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">access</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can plot the results and see how accessibility levels can
differ quite substantially when we account for monetary costs.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot accessibility maps</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">access</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">accessibility</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">max_fare</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Effect of monetary cost on accessibility"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fare_structure_files/figure-html/unnamed-chunk-20-1.png" width="100%"></p>
<div class="section level4">
<h4 id="cleaning-up-after-usage">Cleaning up after usage<a class="anchor" aria-label="anchor" href="#cleaning-up-after-usage"></a>
</h4>
<p><code>r5r</code> objects are still allocated to any amount of memory
previously set after they are done with their calculations. In order to
remove an existing <code>r5r</code> object and reallocate the memory it
had been using, we use the <code>stop_r5</code> function followed by a
call to Java’s garbage collector, as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">r5r</span><span class="fu">::</span><span class="fu"><a href="../reference/stop_r5.html">stop_r5</a></span><span class="op">(</span><span class="va">r5r_core</span><span class="op">)</span></span>
<span><span class="fu">rJava</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rJava/man/jgc.html" class="external-link">.jgc</a></span><span class="op">(</span>R.gc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>If you have any suggestions or want to report an error, please visit
<a href="https://github.com/ipeaGIT/r5r" class="external-link">the package GitHub
page</a>.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marcus Saraiva, Rafael H. M. Pereira, Daniel Herszenhut, Carlos Kaue Vieira Braga, Matthew Wigginton Bhagat-Conway, Ipea - Institute for Applied Economic Research.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
